提问

架构为什么这么设计
公司内类似系统如何实现
架构有哪些可以改善
系统的访问量、存储量、流程和机器数量
系统的瓶颈
机器故障如何容错和容灾
访问量突增，如何过载保护
A/B/C机型区别
专线和内网的带宽
如何实现灰度发布
CSRF的原理 如何解决业务安全问题

Q调（qdiao.qq.com）
总体上讲，接入Q调（qdiao.qq.com）就能系统的解决多出口等复杂的外网调度问题，从而避免踩坑。

L5
4个功能：路由，容灾，负载均衡，过载保护

【路由】
* 无状态：mid+cid
* 有状态：mid + key / mod => cid；每个cid按set组织？
* 一致性Hash：尽可能分配到固定被调（弱状态=>容灾）。使用简单，mid+cid不变，加个set_key

【容灾】L5怎么做容灾？
* 周期60s
* 50%成功率 or 连续1w请求事变

【容灾】L5把机器提了之后怎么检测恢复？
* 3个探测包
* 10w个请求 or 10min -- 可配/conf/qos_config.xml

【负载均衡】算法？
* 周期60s
* 节点权重：静态权重 * 动态权重（基于成功率+时延）
* 每轮基于权重分发
  http://km.oa.com/group/1783/articles/show/126692

【过载保护】怎么判断后端过载？
* 周期60s
* 所有被调50%成功率
* 返回-10000，本周期不发请求？
  【门限收缩算法】

【同类对比】和nds、zk、cmlb相比的特点/优缺点
* 特点：基于cli请求update，简单高效
* 优点：功能/api齐全。有状态/无状态/一致性hash，nds/zk无负载均衡
* 优点：负载均衡。天然支持"就近接入"，比如cli/svr异地部署
* 缺点：容灾上。牺牲请求容灾（多cli），反映慢
* 和cmlb对比？

【架构】
* L5Agent
* L5Config
* L5Server

【使用】
* ApiGetRoute是否会阻塞：第1次调用会（从L5Svr拉取-200ms），后面不会（本机udp）
* 被调ip列表变更，怎么通知主调机器：主调机器L5config每5s去拉取


TGW

问题
* conn/微信接入前端是用TGW？
* 和lvs的区别
* 量
* 作用
* 部署
* 接入方式
* 就近接入
* 安全
* 容灾 
* ip隧道原理？

tgw是做什么用的？3个
* 多网统一接入
* 负载均衡
* ip收敛：ke.qq.com, lol.qq.com都使用同个外网ip（vip）

多网统一接入的实现
* 对外3个TGW接入
* 对内通过ip隧道转发给RS（业务real svr） => Svr拿到的还是用户ip

ip收敛的实现
* 7层 http（web）：按http报头域名
* 4层 vip（cs）：按端口号

相关数据
* 部署：11个大城市（AC/DC）
* 接入应用：2k
* 接入业务Svr：1w
* 一个TGW集群性能：30Gps，400万pps的转发，连接并发数为6000万，转发延时<1ms

tgw安全
* ddos
* 问题：简介/框架；和TGW/CONN区别；性能；就近接入；业务流程/Case；

SSO
* 简介：手Q接入层（=>业务SSOSvr），就近接入/调度，登陆态校验/安全，移动网络特点
* 和CONN区别？：移动网络特点
* 性能（2015.08）：52w在线，2.2w/s请求量，5.2w/s网卡包量；基于C1，瓶颈cpu
- 优化了2轮，2014.12/20w/8k => 2015.04/32w/1.2w
  http://km.oa.com/group/578/articles/show/237071
* 数据（2016.01）：1kw/s（元旦峰值），5百w/s（平时峰值），1.7k机器，1倍冗余部署（理想阀值<50%）

简介
* 移动终端 SDK=>SSO
- 连接：tcp长连（主），http短（辅）为何不用UDP？
- 容灾：基于客户端连接的vip => 多vip+多IDC+多地域
* SSO=>业务SSOSvr
- 连接：udp
- 路由：支持L5/cmlb等
- 容灾：GetIp失败会用CC管理后台的保底IP（后面增加活跃IP池）

能力
* 能力-就近接入：
- 三大运营商：就近接入+测速；深圳（55%）-天津（31%）-上海（12%）
- 中小运营商：CAP？
- 海外用户：香港（2%）；海外用户加速Proxy项目？
  PS：还需推动业务SSOSvr合理异地部署 => 减少专线带宽 
* 能力-调度：上报负载，测速，PushVips给客户端，重定向
* 能力-安全：登陆校验，通信安全，安全打击
- 通信加密：SDK<=>SSO 可选加密（D2+D2key+A2；具体算法和性能消耗？）；SSO<=>业务SSOSvr 明文
- 登陆校验：对终端每个连接都会校验登录态（连接还是请求？），即到业务SSOSvr必定是登陆的
* 能力-异常发现和保护：流量异常等
* 能力-灰度控制：按IP/VIP/号段多维度

移动网络接入特点
* 终端断链重连：GNP+SSO，网络通讯+业务逻辑
* 省流量（40%wifi）：数据压缩（权衡利弊）、智能合并（做法？）、协议精简（头）
* 信令优化：用户=>SSO不用发心跳，SSO=>状态Svr 代发用户心跳。连接断了怎么发消息？
  PS：信令风暴 - 手Q/微信周期性心跳包（控制信息，非数据），防止终端释放链接 => 无法及时收C2C/群小时

实现
* 2个进程：gnp+sso
* 通讯：shm队列，fifo文件通知有请求（同spp？）
- 优化-批量通知：gnp汇总每1ms给sso通知（
- http://km.oa.com/group/578/articles/show/216644

优化
* http://km.oa.com/group/578/articles/show/237071


相关Monitor
http://monitor.server.com/link/graph/viewid:6376
568738 手Q在线（同时）：2015.12.30 - 2.9亿（Android 2.3亿 vs Ios 0.6亿）

相关KM：
深入浅出SSO——手Q接入层首次完整剖析
http://km.oa.com/group/578/articles/show/217888
手Q接入层浅析
http://km.oa.com/articles/show/192179
SSO性能优化
http://km.oa.com/group/578/articles/show/199500
手Q&wns&微信 接入策略比对
http://km.oa.com/group/578/articles/show/199429
sso二次hash算法介绍（sso路由）
http://km.oa.com/group/578/articles/show/216717


防过载方法

1 丢弃在队列已超时请求（worker配置文件msg_timeout，类yaaf）
2 丢弃在worker处理超时请求（异步，CMsg:: SetMsgTimeout）
3 控制worker同时处理请求数（异步，CAsyncFrame:: InitFrame2）、
--- spp


CMEM

cmem性能：B6，分读写
* 正常业务数据：写10w，读28w cpu=> 28w*256B=573Mb/s
* 小数据：写10w，读44w cpu
* 大数据：写7w，读10w io

cmem成本计算（无采购成本，是有运营成本）
* 接入：3w 1个C1（300多/月）
* 存储：45G 1个B6 => 主备*2 （900多/月）
* 对于部落：80多G，2*2B6+2C1约4000元/月


机器类型

物理机
* A5（存储）：4c/32g/12*300g/Raid -- cdb4实例，800块
* B5（Cache）：4c/32g/2*146g/SAS -- 新资料读Svr 32g
* B6（Cache）：2*6c/64g/2*300g/SAS -- 推流转码 64g，788块
* C1（接入）：4c/16g/1T/SATA -- 410块
* 新C1（接入）：8c/16g/500g/SATA -- 腾讯视频转码C1g
* M1（虚拟化/大内存）：2*6c/128g/4*300g/Raid -- 1000块
* Z9（网媒转码/互娱）：2*8c/64g/2*300g/Raid -- 腾讯视频转码最爱Z类 -- 1800块
* TS3（数据冷备）：4c/8g/12*2T/Raid -- 900块
* 红包 TS8：12c/32g/12*300g =》等于1.5个c1 -- 1300块

虚拟机
* vxc2：2核 - 8g
* vxc4：4核 - 16g
* vxc8：6核 - 32g

* 这个是设备情况
  http://obs.oa.com/account/device_discount_strategy
* 成本核算的情况
  http://obs.oa.com/manage_center/account_specialline/index/
  --- 机器设备


3个技术价值观

云中生长，数据银行，有损服务




7个方法论

大系统云做，小工具大做？，Set模型？，全网调度，云控升级，柔性可用，弱联网优化？

-- 价值观



晋级答辩的技巧总结
- T3是什么概念？
    - 动作执行层，任务执行层，项目执行层，愿景执行层
    - 真正的能力和经验的结合
    - 架构师级别
    - 技术深度、广度和实战经验的高度结合
- 答辩的优势和劣势
    - 仅仅只在半小时内展示自己的成果（只看“表现”，不看实际执行）
    - 评委都是有真材实料的高手，一定是自己有把握的问题才拿出来问（不要挑战评委）
    - 答辩的潜台词：我很牛，我符合T3的所有要求
       表现得自信、流畅、思维敏捷
- PPT要怎么写？
    - 封面：突出主题，看一眼就知道你想讲什么；留下自己的名字和组织架构
    - 目录（大纲）：让评委了解你的思路
    - 个人介绍，业绩介绍
    - 产品截图：给一个很具体的东西让别人知道你做了什么
    - 总体架构：复杂，不容易看懂，可以营造不明觉厉的感觉
    - 你负责的部分的具体的架构（绝大多数时间停留在此处），体现出专业度和细致的思考
    - 核心数据结构，算法；难点；亮点
    - KM分享，考核，专利，其他奖励，新人培养
- 其他PPT注意事项：
    - 你在讲你的项目，而不是做了什么，不要流水账
    - PPT越少越好：就像剑法，招式越精简，破绽越少
- 关于项目：
    - 一定要是完整的项目，只讲一件事情
    - 一定要挑有亮点的项目，要能“表现”自己的
    - 要有量：用户量、存储量、在线量、请求量等
    - 一定要有亮点
- 评委一般会挑战什么？
    - 为什么不用XX部门的系统？
    - 你的瓶颈是什么？（任何系统，一定有瓶颈）
    - 你说的XX值，是怎么得来的？
        - 不要拍脑袋，任何值都是计算出来的
        - 勤快点，现场做四则运算
        - 逻辑链条要完善
    - 运营数据：在线量，请求量，存储量等
    - 四大金刚：CPU, 内存，网卡，IO
    - 海量服务价值观：平行扩展，容灾，降级服务，灰度发布
- 要准备什么？
    - 机器类型
    - 机房信息
    - 专线信息
    - 基础知识：OAUTH
    - 模式：AGENT模式
    - 算法等

· 经典架构解析：
      1. TMEM, UDC, grocery，资料系统等：全内存CACHE的大系统，如何实现的
      2. feed系统，微博，QQ空间，部落帖子等：海量UGC数据的组织和读写
      3. 中转系统，CONN，WEBQQ：通讯系统的设计和实现
      4. 长关系链，微博收听关系，手Q公众账号：长关系链系统的实现
      5. 推送和群发系统
      6. TDB, TFS, 海量存储系统



C1 8GB内存 4核8线程 500GB 314元/月 2.53G
B6 64GB内存 2*4核16线程 2*300GB 629元/月  2.13G
TS8 32GB内存 2*6核24线程 12*300GB SSD 1346元/月
A5 32GB内存 1*4核 12*300GB 877元/月
VXC2(M1) 2核8GB 100GB 100元/月
VXC4(M1) 4核16GB 200GB 200元/月
带宽：
深圳IDC带宽成本35元/M/月
CDN带宽成本13元/M/月
CBN专线 国内金牌33元/M/月 银牌铁牌 16元/M/月 铜牌8元/M/月



综合考虑开发周期，稳定性和质量监控体系	