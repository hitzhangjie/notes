# delve简介

delve（简称dlv）是一款专门面向go语言调试而开发的一款调试器，其本身也是通过go语言进行开发。delve相比gdb等调试工具而言，它对go类型系统的理解、运行时把控更加优秀，建议大家使用delve来对go程序进行调试。

调试，是一件比较琐碎的事情，通常我们有一定编程经验之后可能通过error日志就能够定位到问题所在，但是仍然在某些特别刁钻的场景下，我们可能还是要依赖调试器来帮助跟踪定位问题，这里的场景就不列举了，如果想不到这样的场景，那可能也不要调试器，等你意识到打日志难以解决的时候，就更能体会调试器的作用了。

下面描述下delve的一些基本、高级使用技巧。

# 基本调试

## 本地调试

### dlv exec $program

在运行调试器调试程序之前，首先需要得到一个包含了DWARF调试信息的可执行程序，DWARF调试信息的生成需要在执行`go build`的时候通过选项`-N -l`显示指明，其中`-N`表示禁止优化，`-l`表示禁止内联。新的go版本需要指定`-gcflags="all=-N -l"`，其中all表示将-N和-l选项传递到所有的package编译环节中，之前旧版本应该是不需要的。如果希望强制编译所有已经编译过的包可以指定参数`-a`。完整的编译命令即`go build -a -gcflags="all=-N -l"`。

这样编译出程序之后，自带调试符号信息，就可以使用dlv进行调试了，假如程序名是hello，那么运行如下命令即可启动调试：`dlv exec ./hello`，如果希望传递参数信息，可以在`--`之后追加参数信息，如`dlv exec ./hello -- -p1=1 -p2=2`。

### dlv debug $path/main.go

上述操作比较繁琐，需要先自己编译出可执行程序（还需要提供对应的编译选项），然后再启动调试，其实可以一步搞定，直接运行命令：`dlv debug main.go -- p1=1 -p2=2`，dlv会自动传递对应的编译选项完成编译后启动调试。建议用这种方式进行调试，比较简单。

## 远程调试

假如我们将编译好的程序放在测试机hostA上进行测试，我们在开发机hostB上对其进行调试，可能你要问为什么要这样，因为hostA是测试机，没有程序的源代码，调试当然要有源代码才可以查看源代码信息。

这个时候我们可以在hostA上让dlv以headless模式启动某个待调试程序，然后在开发机上也启动dlv，让其连接到hostA上headless模式的dlv进程上。这样开发机上的dlv接收用户的调试指令，并作出相应的处理，然后与hostA上的dlv进程做同步，我们就可以进行远程调试了。

hostA上运行调试：`dlv --headless --listen=:8000 exec ./hello -- -p1=1 -p2=2`
hostB上运行调试：`dlv connect hostA:port`

# 总结

本文主要对dlv的使用做了一些简单的整理、总结。

xxxxxxxxxxxx