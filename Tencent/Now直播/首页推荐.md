# 首页推荐逻辑梳理

## yaaf_personal_live_rcmd_write
服务启动后，根据jungle.worker.list为每一个指定的worklet创建一个dispatcher，然后每个dispatcher为该指定的worklet创建指定数量count个worker，在worker中运行worklet。每个worker监听不同的端口。
----> req ----> server port ----> dispatcher -----> worker ------>exec worklet

HOME_RCMD_PATH: 保存了200个推荐主播列表
HOME_BANNER_PATH：保存了banner配置列表

1 白名单列表：WhiteListAnchorReader
2 在线主播列表：从数据源anchor_online中查出来的
3 黑名单列表：从数据源blacklist中查出来的
4 在线主播评分列表：从数据源anchor_score中查出来的
5 ugc白名单主播列表：从数据源db_qt_entertainment0中select distinct Uin as anchor_uin from tbl_ugc_whitelist_anchor
6 pgc白名单主播列表：从数据源db_qt_entertainment0中select distinct nw_uin as anchor_uin,nw_termination_state from ilive_personal_PGC_anchors
7 推荐白名单列表：RcmdWhiteListReader
8 房间黑名单列表：RoomBlackListMapper
9 banner列表：PageBannerMapper
10 属性配置：从数据源prop_user_detail加载
11 标签配置列表：LabelSynchronizer从zk加载
12 主播聊天rate列表：从数据源anchor_score中根据select anchor_uin,chat_user_rate_rank from t_anchor_score_online order by chat_user_rate_rank desc查询得到
13 推荐限制：10~10000，这里应该是数量限制吧
14 特殊位置配置（个性化推荐相关）：从数据源special_position中通过select tail_num, insert_pos from t_scene_rcmd_conf where tail_num>0 limit 0,100查询得到；
15 0x6001，ILiveServiceNew，批量拉取主播列表；

HomeRcmdTask逻辑 {
- 拉取在线主播列表uinList；
- uinList中50个uin一次请求，iliveservice批量拉取在线主播信息，并全部存储到anchorOnlineList中；
- 将${anchor_uin}_${anchor_score}保存到lastUidOrder中；
- 如果当前正在开播的主播数量小于zk中设置的最小值10，就触发降级逻辑：不更新tmem数据；
- 从anchorOnline这个List<Map>中获取所有的在线主播的uin列表uinList（这里的uinList中是用户信息成功获取到的用户uin，没有获取到的不包括在这里）；
- 为anchorOnlineList中的主播添加评分；
- 按照评分由大到小对anchorOnlineList中的元素进行排序；
- 补充主播pgc、ugc信息；
- 补充主播房间相关信息；
- 补充主播房间在线人数信息；
- 补充主播基本信息，包含昵称签名；
- 补充主播勋章信息；
- 补充主播qzone信息；
- 加速卡使用信息添加；
- 将个性化推荐的位置重新刷新到zk；
- 补充主播聊天率；
- 将全部推荐写入到zk节点；
}

推荐主播列表：首页推荐列表每隔1s钟reload一次！
首页banne列表：banner推荐列表

写tmem：
tmem文本写入：配置是否写文本，是的话写index_rcmd_key=plive_rcmd
tmem gzip写入：配置是否写gzip，是的话写index_rcmd_gzip_key=plive_rcmd_gzip

## yaaf_personal_live_rcmd_read

PropertiesProcessorService类，根据server.name以及${server.name}.p作为前缀查找请求命令字cmd与对应的处理类XXXProcessor的对应关系，并建立起映射关系。以后请求来的时候，通过请求命令字查找对应的XXXProcessor对请求进行处理，完成。

now独立版首页推荐的花，重点看```p.100```这个命令字及其处理类```GetHomeRcmdNewProcessor```就可以了。

GetHomeRcmdNewProcessor处理逻辑 {
- 获取分页拉首页的参数：第几页index，每页数量count；
- 获取参数：是否拉取banner；
- 检查index、count是否合法；
- 根据client_type获取appid；
- 如果appid=1003表示是动漫过来的，通过getAppInfo直接构建推荐列表返回；
- 从loading cache里面获取数据，rcmdMap=cache.get("_index_new")；
- iliveService根据index、count获取推荐列表；
- 
}

拉取推荐列表命令字：0x5100 0x64，也就是p.100=com.tencent.....GetHomeRcmdNewProcessor。




