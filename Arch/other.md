腾讯后端逻辑服务多基于微线程化的SPP同步框架进行开发，常用的后端组件包括CDB、CKV、Redis、ES、CFS等。

# 2 开发环境

## 2.1 机器分类
- **开发机**  
开发机指用于开发、办公的机器，比如公司给我们提供的台式机，但是某些时候我们也会申请云主机、虚拟机作为开发机使用，比如SPP、Jungle相关工程的构建，考虑到库依赖、编译工具链兼容性问题，我们会使用统一的机器进行开发、构建工作，所以某种意义上，这里的机器也是开发机，也是编译机。
- **编译机**  
编译机指用于专门的构建工作的机器，一般不使用其进行开发，比如SPP、Jungle相关工程的构建，考虑到库依赖、编译工具链兼容性问题，我们会使用统一的机器进行构建。
- **测试机**  
测试机指用于进行测试验证的机器，一般构建完成后，需要在测试环境下对程序进行测试、验证、压测，完成这些工作的情况下，才允许进一步到预发布机进行验证，然后才允许发布线网。
- **预发布机**  
预发布机与现网机都能拉取到现网数据，唯一不同的是预发布机不处于负载均衡调度器的设备列表中，因此用户请求不会落到预发布机上，预发布机的这一特点可以使我们验证现网配置环境下、网络环境下程序是否工作正常。
- **现网机**  
现网机指生产环境下的机器，现网机处于负载均衡设备调度器的设备列表中，用户请求由负载均衡设备转发到指定的某台现网机上进行处理。现网机涉及现网环境、数据等，开发人员、运维人员访问现网机时必须做到受限访问，避免访问人员权限过高情况下因为误操作对现网数据造成的破坏。

## 2.2 网络访问
公司内网络也划分地很细致，如办公网、开发网、员工网络、访客网络等等，其目的是为了更加细致地访问授权，不同网络接入可以访问的内网资源也是不一样的。

- **OfficeWifi**  
接入后允许办公人员访问OA站点，允许访问外网，但是不能访问SVN、Git等资源，不能登录跳板机，更不能访问现网机器。
- **DevNet**  
接入后允许开发人员访问SVN、Git等资源，也允许访问OA站点，也允许访问外网但需申请（每次申请有两小时限时），允许访问跳板机，但是不能访问现网机器。
- **StaffWifi**  
接入后允许工作人员访问外网，不能访问内网任何资源。
- **GuestWifi**  
接入后允许游客访问外网，不能访问内网任何资源。

## 2.3 网络工具
- **VPN**  
VPN指的是在公司外部网络环境下如何接入内网而常用的一种技术，全称Virtual Private Network，腾讯内部的VPN分为办公VPN、运维VPN、开发VPN、客服VPN这4种，之所以划分这么细致是为了精细的权限控制，使用起来虽然有点麻烦，但是一定程度上提高了工作人员的安全意识，也确实提供了一定的安全保障。
- **远程桌面**  
开发机上的IDE等开发工具有助于提高开发人员效率，有时开发人员需要在公司外部网络环境中访问开发机进行开发，这个时候需要在登录开发VPN的前提下，借助远程桌面（如Windows下mstsc）来登录开发机远程桌面服务。用户需要打开开发机远程桌面服务、打开防火墙并根据VPN分配的IP地址来设置合适的入站规则。Ctrl+Alt+Pause可以很方便地切换远程桌面全屏显示。
- **rz/sz**  
rz/sz常用于在客户端和服务器之间传输文件，其中rz是用于上传操作，sz是用于下载操作。通过rz上传文件时要注意，尽量不要勾选一ASCII方式上传，因为我们可能上传的文件是图片这类二进制文件，如果以ASCII方式上传则可能导致文件被截断。

# 3 BugFix
在工作、学习过程中学习到了一些定位、分析bug的技巧，在这里几种进行一下总结，有些技能真的是不常用就忘了，回家呆了两个月，回到公司后发现很多之前积累起来的知识被“遗忘”了，其实还是没有完全掌握，只能算是“初识”该技能，好几性不如烂笔头，还是要多做总结、多回顾，有问题的时候即便记不起来了也可以快速查询。

## 3.1 coredump
#### 3.1.1 coredump
Linux下进程收到下面这5个常见信号时，会终止进程生成core文件。
- SIGQUIT，quit from keyboard；
- SIGILL，illegal instruction；
- SIGABRT，abort signal from abort(3)；
- SIGFPE，floating point exception；
- SIGSEGV，invalid memory reference；

#### 3.1.2 core文件大小
core文件大小是有限制的，默认都是0，意味着不会生成core文件，可以通过 ```ulimit -c``` 进行查看，也可以通过 ```ulimit -c $size``` 进行修改，但是命令只对当前shell有效，重启一个shell或者重启机器都会恢复为系统默认设置。如果想永久保留此设置可以在 ```/etc/profile``` 或者 ```/etc/bashrc``` 中进行配置。

#### 3.1.3 core文件命名
core文件命名模式是可以指定的，在 ```/etc/sysctl.conf``` 中添加如下配置即可在程序coredump时在当前程序目录生成core文件，```kernel.core_pattern=core-%e(%s).%p.%t```。对这里的配置选项进行简单说明：

- %e，executable filename (withouth path prefix)；
- %s，number of signal causing dump；
- %p，PID of dumped process;
- %t，time of dump，unix timestamp；

其他配置选项可以通过man core进行查询。

core文件名后面的时间戳不好辨认，可以通过命令将其转成可读的、易理解的字符串，```date -d @time```。

#### 3.1.4 分析core文件
假如当前可执行文件名是prog，生成的core文件是core-prog(11).12345.1490000000，那么执行命令 `gdb prog core-prog(11).12345.1490000000`，通过该命令来定位到该进程12345收到信号11 coredump时的内存状态，通过对其调用栈进行分析可以找到进程coredump的原因，这里的kernel.core_pattern中的信号选项%s其实也是很重要的，通过进程收到的信号大体可以猜到接收该信号的原因，便于辅助定位问题，例如信号11表示SIGSEGV，其往往是因为内存访问非法所致，这个时候就可以重点分析内存是否存在越界等。

另外为了方便分析coredump，这里的prog可执行程序在构建时最好加入调试符号，编译程序时为gcc指定选项**gcc -g**。一般gdb prog $core-file分析时最后会打印出程序发生coredump时的堆栈信息便于分析。

# 4 日志系统

## 4.1 ULS
ULS是腾讯内部使用的远程日志系统，对于记录后端服务的流水日志、定位问题有非常大的帮助。为了便于定位问题，常常会让服务程序打印日志信息到日志文件，但是多机部署之后定位问题就变得非常繁琐了，需要登录多台机器去检查日志文件，就算是写脚本自动化这一过程也是很麻烦的，因为日志文件不能积累太多需要定期清理，一旦有效的日志信息被清理掉了，也就无法还原问题场景了，不利于定位问题。远程日志系统是一个不错的解决方案，腾讯内部广泛采用ULS来解决这一问题。

## 4.2 业务日志

## 4.3 框架日志

## 4.4 敏感操作上报

# 5 常用功能

## 5.1 频率限制
同一个用户一分钟最多允许请求一次或者几次？这样的限制在某些服务中也普遍存在，这就是请求频率限制。如何实现这样的功能呢？可以通过一个map<uid,map<min,cnt>>对用户uid在第min分钟内的请求次数cnt进行记录，当cnt超过允许的max_cnt后就拒绝处理用户请求，并在当前时间>min之后清空统计的该uid的请求次数。

这就是一种简单的请求频率限制的实现方案。

# X 附录




